# [HarmonyLab] ðŸ”µ User Authentication â€” Same Pattern as Super-Flashcards/MetaPM

> **From**: Claude.ai (Architect)
> **To**: Claude Code (Command Center)
> **Project**: ðŸ”µ HarmonyLab
> **Task**: user-auth-implementation
> **Timestamp**: 2026-02-07T20:15:00Z
> **Priority**: HIGH â€” Blocks Quiz/Progress functionality

---

## Context

v1.4.0 UI is deployed but Quiz and Progress pages don't work because they need `user_id`. 

**Solution**: Implement the same authentication pattern already working in Super-Flashcards and MetaPM.

---

## Reference Implementations

Study these existing implementations:

### Super-Flashcards
- `G:\My Drive\Code\Python\Super-Flashcards\app\services\auth_service.py`
- `G:\My Drive\Code\Python\Super-Flashcards\app\routers\auth.py`
- `G:\My Drive\Code\Python\Super-Flashcards\frontend\js\auth.js`

### MetaPM
- `G:\My Drive\Code\Python\metapm\app\services\auth_service.py`
- `G:\My Drive\Code\Python\metapm\app\api\auth.py`
- `G:\My Drive\Code\Python\metapm\frontend\js\auth.js`

---

## Implementation Requirements

### 1. Backend: Auth Service

Create `app/services/auth_service.py` following the Super-Flashcards pattern:

```python
# Key components needed:
# - Google OAuth 2.0 integration
# - JWT token generation/validation
# - Session management
# - User creation on first login
```

### 2. Backend: Auth Router

Create `app/routers/auth.py`:

```python
# Endpoints needed:
# POST /api/v1/auth/google - Handle Google OAuth callback
# POST /api/v1/auth/refresh - Refresh JWT token
# POST /api/v1/auth/logout - Invalidate session
# GET /api/v1/auth/me - Get current user
```

### 3. Backend: Auth Middleware

Add authentication middleware that:
- Extracts JWT from `Authorization: Bearer` header
- Validates token
- Adds `user_id` to request state
- Allows unauthenticated access to public endpoints (songs list, health)

### 4. Database: Users Table

```sql
CREATE TABLE Users (
    UserID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Email NVARCHAR(255) NOT NULL UNIQUE,
    DisplayName NVARCHAR(255),
    GoogleID NVARCHAR(255) UNIQUE,
    AvatarURL NVARCHAR(500),
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    LastLoginAt DATETIME2,
    IsActive BIT DEFAULT 1
);

CREATE INDEX IX_Users_Email ON Users(Email);
CREATE INDEX IX_Users_GoogleID ON Users(GoogleID);
```

### 5. Frontend: Auth Module

Create `frontend/js/auth.js`:

```javascript
// Key functions needed:
// - initGoogleAuth() - Initialize Google Sign-In
// - handleGoogleCallback(response) - Process OAuth response
// - getAuthToken() - Get current JWT from localStorage
// - refreshToken() - Refresh expired token
// - logout() - Clear session
// - getCurrentUser() - Get user info
// - isAuthenticated() - Check if logged in
```

### 6. Frontend: Login UI

Add to all pages (or create `login.html`):

```html
<!-- Google Sign-In button -->
<div id="auth-container">
    <div id="logged-out-view">
        <div id="g_id_onload"
            data-client_id="YOUR_GOOGLE_CLIENT_ID"
            data-callback="handleGoogleCallback">
        </div>
        <div class="g_id_signin" data-type="standard"></div>
    </div>
    <div id="logged-in-view" style="display:none;">
        <img id="user-avatar" class="avatar" />
        <span id="user-name"></span>
        <button onclick="logout()">Logout</button>
    </div>
</div>
```

### 7. Update Quiz/Progress Pages

Update `quiz.html` and `progress.html` to:
1. Check authentication on load
2. Redirect to login if not authenticated
3. Include `user_id` in API calls

---

## Google OAuth Setup

If not already configured for HarmonyLab:

1. Go to Google Cloud Console â†’ APIs & Services â†’ Credentials
2. Create OAuth 2.0 Client ID (Web application)
3. Add authorized origins:
   - `https://harmonylab.rentyourcio.com`
   - `http://localhost:8000` (for development)
4. Add authorized redirect URIs:
   - `https://harmonylab.rentyourcio.com/auth/callback`
5. Store Client ID in Secret Manager as `harmonylab-google-client-id`
6. Store Client Secret in Secret Manager as `harmonylab-google-client-secret`

---

## Testing Checklist

| Test | Expected |
|------|----------|
| Google Sign-In button appears | âœ… |
| Click Sign-In â†’ Google popup | âœ… |
| Complete OAuth â†’ Redirected back | âœ… |
| User info displayed | âœ… |
| Quiz page loads with user context | âœ… |
| Quiz API calls include user_id | âœ… |
| Progress page shows user's data | âœ… |
| Logout clears session | âœ… |
| Refresh token works | âœ… |

---

## Version Bump

Update to **v1.4.1** after auth implementation:
- `main.py`
- `frontend/index.html`
- `frontend/song.html`
- `frontend/quiz.html`
- `frontend/progress.html`

---

## Files to Create/Modify

### New Files
- `app/services/auth_service.py`
- `app/routers/auth.py`
- `frontend/js/auth.js`

### Modified Files
- `app/main.py` â€” Add auth router, middleware
- `app/migrations.py` â€” Add Users table
- `frontend/index.html` â€” Add auth UI
- `frontend/song.html` â€” Add auth UI
- `frontend/quiz.html` â€” Add auth check, update API calls
- `frontend/progress.html` â€” Add auth check, update API calls
- `frontend/styles.css` â€” Auth UI styling

---

## Definition of Done

- [ ] Users table created
- [ ] Auth service implemented (matching Super-Flashcards pattern)
- [ ] Auth router implemented
- [ ] Auth middleware added
- [ ] Google OAuth configured
- [ ] Frontend auth.js created
- [ ] Login UI added to all pages
- [ ] Quiz page uses authenticated user_id
- [ ] Progress page uses authenticated user_id
- [ ] Token refresh working
- [ ] Logout working
- [ ] Version bumped to 1.4.1
- [ ] Deployed and tested
- [ ] Handoff sent with completion report

---

*Auth implementation spec from Claude.ai (Architect)*
*Pattern: Copy from Super-Flashcards/MetaPM â€” proven to work*
