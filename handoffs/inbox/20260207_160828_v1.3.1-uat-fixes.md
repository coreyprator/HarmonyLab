# [HarmonyLab] ðŸ”µ v1.3.1 Fixes Required â€” UAT Failures

> **From**: Claude.ai (Architect)
> **To**: Claude Code (Command Center)
> **Project**: ðŸ”µ HarmonyLab
> **Task**: v1.3.1-uat-fixes
> **Timestamp**: 2026-02-07T18:30:00Z
> **Priority**: HIGH

---

## UAT Results Summary

**8 Passed / 3 Failed**

| Failed Test | Issue | Fix Required |
|-------------|-------|--------------|
| Quiz/Progress tooltip | No "Coming in v1.4.0" on hover | Add `title` attribute to disabled links |
| Ab chord shows "?" | music21 can't parse "Ab" alone | Handle chords without quality suffix |
| Version shows v1.3.0 | Not bumped | Update to v1.3.1 |

---

## Fix 1: Tooltip on Disabled Nav Links

**File**: `frontend/index.html` and `frontend/song.html`

**Current** (apparently not working):
```html
<a href="#" class="nav-link disabled" title="Coming in v1.4.0">Quiz</a>
```

**Verify or Add**:
```html
<a href="#" class="nav-link disabled" title="Coming in v1.4.0" aria-disabled="true">Quiz</a>
<a href="#" class="nav-link disabled" title="Coming in v1.4.0" aria-disabled="true">Progress</a>
```

**Also add CSS** to ensure tooltip shows:
```css
.nav-link.disabled {
    cursor: not-allowed;
    opacity: 0.5;
    pointer-events: auto; /* Required for tooltip to show! */
}

.nav-link.disabled:hover {
    text-decoration: none;
}
```

**Note**: `pointer-events: none` blocks tooltips! Use `auto` with `cursor: not-allowed` instead.

---

## Fix 2: "Ab" Chord Shows "?"

**Problem**: music21 can't parse chords without quality suffix like "Ab" (just the root).

**File**: `app/services/analysis_service.py`

**Root Cause**: `harmony.ChordSymbol("Ab")` may fail or return ambiguous result.

**Fix** â€” Add fallback in `_analyze_chord()`:

```python
def _analyze_chord(self, symbol: str, index: int) -> Dict:
    """Analyze single chord with fallback for simple roots."""
    try:
        # Normalize symbol - add major if just a root
        normalized = self._normalize_chord_symbol(symbol)
        
        c = harmony.ChordSymbol(normalized)
        rn = roman.romanNumeralFromChord(c, self.current_key)
        
        # Use jazz-style formatting
        roman_str = self._format_jazz_roman(rn, c)
        
        func = self._get_function(rn)
        # ... rest of analysis
        
    except Exception as e:
        logger.warning(f"Could not analyze {symbol}: {e}")
        # Return unknown instead of crashing
        return {
            "index": index,
            "symbol": symbol,
            "roman": "?",
            "function": "unknown",
            # ...
        }

def _normalize_chord_symbol(self, symbol: str) -> str:
    """Normalize chord symbols for music21 parsing."""
    
    # If just a note letter (with optional accidental), assume major
    # e.g., "Ab" â†’ "Abmaj" or "AbM"
    import re
    
    # Pattern: just root note with optional accidental
    root_only = re.match(r'^([A-G][b#]?)$', symbol)
    if root_only:
        return symbol + "maj"  # Assume major triad
    
    # Handle other common variations
    # "Ab7" is fine, "Abm" is fine, etc.
    return symbol
```

**Test Cases**:
- "Ab" â†’ should analyze as â™­VI or â™­VII depending on key
- "Ab7" â†’ should work
- "Abm7" â†’ should work
- "Abmaj7" â†’ should work

---

## Fix 3: Version Bump

**Update to v1.3.1** in:

| File | Location |
|------|----------|
| `config/settings.py` | `VERSION = "1.3.1"` |
| `app/main.py` | If version defined there |
| `frontend/index.html` | Nav bar badge, footer |
| `frontend/song.html` | Nav bar badge |

---

## Fix 4: Clear Analysis Cache

**CRITICAL**: Clear stale cached analysis data.

```sql
-- Run in SQL Server
UPDATE SongAnalysis SET analysis_json = NULL;
```

Or add a backend migration that clears on version change.

---

## Deployment Checklist

- [ ] Fix tooltip CSS (`pointer-events: auto`)
- [ ] Add `_normalize_chord_symbol()` method
- [ ] Update `_analyze_chord()` to use normalizer
- [ ] Bump version to v1.3.1 in all files
- [ ] Clear SongAnalysis cache
- [ ] Deploy backend
- [ ] Deploy frontend
- [ ] **VERIFY on live URL before claiming complete**:
  - [ ] Hover over Quiz link â†’ tooltip shows
  - [ ] Ab chord shows Roman numeral (not "?")
  - [ ] Version shows v1.3.1
  - [ ] Roman numerals are jazz-style

---

## Testing Commands

After deployment, verify:

```bash
# Health check
curl https://harmonylab.rentyourcio.com/health

# Analysis endpoint (Corcovado)
curl https://harmonylab-wmrla7fhwa-uc.a.run.app/api/v1/analysis/songs/23?refresh=true
```

Check that:
1. Version is 1.3.1
2. Ab chord has a Roman numeral, not "?"
3. Other chords still have jazz-style notation

---

## Definition of Done

- [ ] All 3 UAT failures fixed
- [ ] Deployed and verified on live URL
- [ ] **You personally tested all 3 fixes**
- [ ] Sent completion report via handoff bridge

---

*Fixes specified by Claude.ai (Architect) based on UAT results from Corey (Project Lead)*
