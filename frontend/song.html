<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song - HarmonyLab</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Tone.js for audio playback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
</head>
<body style="display: none;">
    <!-- Navigation Bar -->
    <nav class="main-nav">
        <a href="index.html" class="nav-brand">HarmonyLab</a>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Songs</a>
            <a href="quiz.html" class="nav-link">Quiz</a>
            <a href="progress.html" class="nav-link">Progress</a>
        </div>
        <div id="auth-container" class="nav-auth">
            <a href="https://harmonylab-wmrla7fhwa-uc.a.run.app/api/v1/auth/google/login" class="btn btn-sm btn-primary">Sign in</a>
        </div>
        <div class="nav-version">v2.0.1</div>
    </nav>

    <header>
        <div class="header-content">
            <h1 id="song-title">Loading...</h1>
        </div>
        <div class="song-info">
            <span id="song-composer"></span>
            <span id="song-key" class="key-badge"></span>
            <span id="detected-key-header" class="key-badge detected"></span>
            <span id="song-genre" class="genre-badge"></span>
            <span id="song-time"></span>
        </div>
    </header>

    <main>
        <!-- View Toggle + Analysis Controls -->
        <div class="controls-bar">
            <div class="view-toggle">
                <label><input type="radio" name="view" value="chords"> Chords</label>
                <label><input type="radio" name="view" value="analysis" checked> Analysis</label>
                <label><input type="radio" name="view" value="notes"> Notes</label>
            </div>
            <button id="export-btn" class="btn btn-sm" title="Export to MuseScore with analysis annotations">Export .mscz</button>

            <div class="analysis-controls" id="analysis-controls" style="display:none">
                <label>Key:</label>
                <select id="key-select">
                    <option value="">Auto-detect</option>
                    <option value="C">C major</option>
                    <option value="c">C minor</option>
                    <option value="D-">Db major</option>
                    <option value="c#">C# minor</option>
                    <option value="D">D major</option>
                    <option value="d">D minor</option>
                    <option value="E-">Eb major</option>
                    <option value="e-">Eb minor</option>
                    <option value="E">E major</option>
                    <option value="e">E minor</option>
                    <option value="F">F major</option>
                    <option value="f">F minor</option>
                    <option value="F#">F# major</option>
                    <option value="f#">F# minor</option>
                    <option value="G">G major</option>
                    <option value="g">G minor</option>
                    <option value="A-">Ab major</option>
                    <option value="g#">G# minor</option>
                    <option value="A">A major</option>
                    <option value="a">A minor</option>
                    <option value="B-">Bb major</option>
                    <option value="b-">Bb minor</option>
                    <option value="B">B major</option>
                    <option value="b">B minor</option>
                </select>
                <button id="reanalyze-btn" class="btn btn-sm">Re-analyze</button>
                <span id="detected-key" class="detected-key"></span>
                <span id="confidence" class="confidence"></span>
            </div>
        </div>

        <!-- Function Legend (analysis view) -->
        <div class="function-legend" id="function-legend" style="display:none">
            <span class="legend-item"><span class="legend-dot tonic"></span> Tonic (I, iii, vi)</span>
            <span class="legend-item"><span class="legend-dot subdominant"></span> Subdominant (ii, IV)</span>
            <span class="legend-item"><span class="legend-dot dominant"></span> Dominant (V, vii)</span>
            <span class="legend-item"><span class="legend-dot secondary"></span> Secondary Dom</span>
            <span class="legend-item"><span class="legend-dot chromatic"></span> Chromatic</span>
        </div>

        <!-- Pattern info -->
        <div id="patterns-info" class="patterns-info" style="display:none"></div>

        <!-- Rhythm Analysis Panel (FAIL 4) -->
        <div id="rhythm-panel" class="rhythm-panel" style="display:none">
            <div class="rhythm-header">Rhythm Analysis</div>
            <div class="rhythm-details">
                <span class="rhythm-badge" id="rhythm-feel">--</span>
                <span class="rhythm-stat">Swing ratio: <strong id="rhythm-ratio">--</strong></span>
                <span class="rhythm-stat">Syncopation: <strong id="rhythm-sync">--</strong></span>
                <span class="rhythm-stat">Subdivision: <strong id="rhythm-subdiv">--</strong></span>
                <span class="rhythm-source" id="rhythm-source"></span>
            </div>
        </div>

        <!-- MIDI Status Panel (FAIL 5) -->
        <div id="midi-panel" class="midi-panel">
            <div class="midi-status" id="midi-status">MIDI: Checking...</div>
            <div class="midi-chord-display" id="midi-chord-display" style="display:none">
                <span class="midi-chord-symbol" id="midi-chord-symbol"></span>
                <span class="midi-chord-roman" id="midi-chord-roman"></span>
            </div>
        </div>

        <!-- Chord Display -->
        <div id="chord-display" class="chord-display">
            <p class="loading">Loading chords...</p>
        </div>

        <!-- Notes View (FAIL 1) -->
        <div id="notes-display" style="display:none">
            <div id="notes-content"></div>
        </div>

        <!-- Sections -->
        <div id="sections-display"></div>
    </main>

    <!-- Chord Symbol Edit Modal (Chords View) -->
    <div id="chord-edit-modal" class="modal" style="display:none">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Chord</h3>
                <button class="modal-close" onclick="closeChordEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Current</label>
                    <input type="text" id="edit-current-symbol" readonly class="input-readonly">
                </div>
                <div class="form-group">
                    <label>Root</label>
                    <select id="edit-root" onchange="updateChordPreview()">
                        <option value="C">C</option><option value="C#">C#</option><option value="Db">Db</option>
                        <option value="D">D</option><option value="D#">D#</option><option value="Eb">Eb</option>
                        <option value="E">E</option>
                        <option value="F">F</option><option value="F#">F#</option><option value="Gb">Gb</option>
                        <option value="G">G</option><option value="G#">G#</option><option value="Ab">Ab</option>
                        <option value="A">A</option><option value="A#">A#</option><option value="Bb">Bb</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quality</label>
                    <select id="edit-quality" onchange="updateChordPreview()">
                        <option value="">Major</option>
                        <option value="m">Minor (m)</option>
                        <option value="7">Dom 7</option>
                        <option value="maj7">Maj 7</option>
                        <option value="m7">Min 7</option>
                        <option value="dim">Dim</option>
                        <option value="dim7">Dim 7</option>
                        <option value="m7b5">Half-dim (m7b5)</option>
                        <option value="aug">Aug</option>
                        <option value="aug7">Aug 7</option>
                        <option value="mmaj7">Min Maj 7</option>
                        <option value="6">Maj 6</option>
                        <option value="m6">Min 6</option>
                        <option value="9">Dom 9</option>
                        <option value="maj9">Maj 9</option>
                        <option value="m9">Min 9</option>
                        <option value="13">Dom 13</option>
                        <option value="sus4">Sus4</option>
                        <option value="sus2">Sus2</option>
                        <option value="7#9">7#9</option>
                        <option value="7b9">7b9</option>
                        <option value="alt">Altered</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Extension <small style="font-weight:normal;color:#888">(optional)</small></label>
                    <select id="edit-extension" onchange="updateChordPreview()">
                        <option value="">None</option>
                        <option value="9">9</option>
                        <option value="b9">b9</option>
                        <option value="#9">#9</option>
                        <option value="11">11</option>
                        <option value="#11">#11</option>
                        <option value="13">13</option>
                        <option value="b13">b13</option>
                        <option value="add9">add9</option>
                        <option value="add11">add11</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bass Note <small style="font-weight:normal;color:#888">(optional, for slash chords)</small></label>
                    <select id="edit-bass" onchange="updateChordPreview()">
                        <option value="">None</option>
                        <option value="C">C</option><option value="C#">C#</option><option value="Db">Db</option>
                        <option value="D">D</option><option value="D#">D#</option><option value="Eb">Eb</option>
                        <option value="E">E</option>
                        <option value="F">F</option><option value="F#">F#</option><option value="Gb">Gb</option>
                        <option value="G">G</option><option value="G#">G#</option><option value="Ab">Ab</option>
                        <option value="A">A</option><option value="A#">A#</option><option value="Bb">Bb</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>New Chord</label>
                    <div id="edit-preview" style="font-size:1.4rem;font-weight:bold;padding:8px 0;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeChordEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveChordEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- Chord Analysis Override Modal (Analysis View) -->
    <div id="chord-modal" class="modal" style="display:none">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Chord Analysis</h3>
                <button class="modal-close" onclick="closeChordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Root</label>
                    <select id="modal-root" onchange="updateAnalysisChordPreview()">
                        <option value="C">C</option><option value="C#">C#</option><option value="Db">Db</option>
                        <option value="D">D</option><option value="D#">D#</option><option value="Eb">Eb</option>
                        <option value="E">E</option>
                        <option value="F">F</option><option value="F#">F#</option><option value="Gb">Gb</option>
                        <option value="G">G</option><option value="G#">G#</option><option value="Ab">Ab</option>
                        <option value="A">A</option><option value="A#">A#</option><option value="Bb">Bb</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quality</label>
                    <select id="modal-quality" onchange="updateAnalysisChordPreview()">
                        <option value="">Major</option>
                        <option value="m">Minor (m)</option>
                        <option value="7">Dom 7</option>
                        <option value="maj7">Maj 7</option>
                        <option value="m7">Min 7</option>
                        <option value="dim">Dim</option>
                        <option value="dim7">Dim 7</option>
                        <option value="m7b5">Half-dim (m7b5)</option>
                        <option value="aug">Aug</option>
                        <option value="aug7">Aug 7</option>
                        <option value="mmaj7">Min Maj 7</option>
                        <option value="6">Maj 6</option>
                        <option value="m6">Min 6</option>
                        <option value="9">Dom 9</option>
                        <option value="maj9">Maj 9</option>
                        <option value="m9">Min 9</option>
                        <option value="13">Dom 13</option>
                        <option value="sus4">Sus4</option>
                        <option value="sus2">Sus2</option>
                        <option value="7#9">7#9</option>
                        <option value="7b9">7b9</option>
                        <option value="alt">Altered</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Extension <small style="font-weight:normal;color:#888">(optional)</small></label>
                    <select id="modal-ext" onchange="updateAnalysisChordPreview()">
                        <option value="">None</option>
                        <option value="9">9</option>
                        <option value="b9">b9</option>
                        <option value="#9">#9</option>
                        <option value="11">11</option>
                        <option value="#11">#11</option>
                        <option value="13">13</option>
                        <option value="b13">b13</option>
                        <option value="add9">add9</option>
                        <option value="add11">add11</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bass Note <small style="font-weight:normal;color:#888">(optional, for slash chords)</small></label>
                    <select id="modal-bass" onchange="updateAnalysisChordPreview()">
                        <option value="">None</option>
                        <option value="C">C</option><option value="C#">C#</option><option value="Db">Db</option>
                        <option value="D">D</option><option value="D#">D#</option><option value="Eb">Eb</option>
                        <option value="E">E</option>
                        <option value="F">F</option><option value="F#">F#</option><option value="Gb">Gb</option>
                        <option value="G">G</option><option value="G#">G#</option><option value="Ab">Ab</option>
                        <option value="A">A</option><option value="A#">A#</option><option value="Bb">Bb</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Chord Symbol Preview</label>
                    <div id="modal-symbol-preview" style="font-size:1.4rem;font-weight:bold;padding:8px 0;"></div>
                </div>
                <hr style="border:none;border-top:1px solid var(--border);margin:8px 0">
                <div class="form-group">
                    <label>Roman Numeral (auto)</label>
                    <input type="text" id="modal-roman-auto" readonly class="input-readonly">
                </div>
                <div class="form-group">
                    <label>Roman Numeral Override</label>
                    <input type="text" id="modal-roman" placeholder="e.g. V/vi">
                </div>
                <div class="form-group">
                    <label>Function Override</label>
                    <select id="modal-function">
                        <option value="">Auto</option>
                        <option value="tonic">Tonic</option>
                        <option value="subdominant">Subdominant</option>
                        <option value="dominant">Dominant</option>
                        <option value="secondary">Secondary Dominant</option>
                        <option value="chromatic">Chromatic</option>
                        <option value="diminished">Diminished</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Key Context Override</label>
                    <input type="text" id="modal-key-context" placeholder="e.g. A minor">
                </div>
                <div class="form-group checkbox-group">
                    <label><input type="checkbox" id="modal-is-pivot"> Pivot Chord</label>
                </div>
                <div class="form-group" id="pivot-key-group" style="display:none">
                    <label>Pivot To Key</label>
                    <input type="text" id="modal-pivot-key" placeholder="e.g. G major">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-notes" rows="2" placeholder="Analysis notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteOverride()">Reset to Auto</button>
                <button class="btn" onclick="closeChordModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveOverride()">Save Override</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname.includes('localhost')
            ? 'http://localhost:8080'
            : 'https://harmonylab-wmrla7fhwa-uc.a.run.app';

        const params = new URLSearchParams(window.location.search);
        const songId = params.get('id');

        let currentView = 'analysis';
        let songData = null;
        let analysisData = null;
        let allChords = [];
        let editingChordIndex = null;

        // ==========================================
        // INITIALIZATION
        // ==========================================

        async function init() {
            if (!songId) {
                document.getElementById('chord-display').innerHTML =
                    '<p class="error">No song ID provided.</p>';
                return;
            }
            await loadSong();
            await loadSongChords();
            // Pre-load analysis to show detected key in header
            await loadAnalysisForHeader();
            // Default to Analysis view (HL-010)
            switchView('analysis');
            // Load rhythm analysis (FAIL 4)
            loadRhythmAnalysis();
            // Init MIDI (FAIL 5)
            initMIDI();
        }

        async function loadAnalysisForHeader() {
            try {
                const url = `${API_BASE}/api/v1/analysis/songs/${songId}`;
                const res = await fetch(url);
                if (!res.ok) return;
                analysisData = await res.json();

                // Update header with detected key
                const detectedKeyEl = document.getElementById('detected-key-header');
                if (analysisData.detected_key) {
                    detectedKeyEl.textContent = `Detected: ${analysisData.detected_key}`;
                    detectedKeyEl.style.display = '';
                }
            } catch (err) {
                console.log('Analysis pre-load skipped:', err.message);
            }
        }

        // ==========================================
        // DATA LOADING
        // ==========================================

        async function loadSong() {
            try {
                const res = await fetch(`${API_BASE}/api/v1/songs/${songId}`);
                if (!res.ok) throw new Error('Song not found');
                songData = await res.json();

                document.getElementById('song-title').textContent = songData.title || 'Untitled';
                document.title = `${songData.title} - HarmonyLab`;

                if (songData.composer)
                    document.getElementById('song-composer').textContent = songData.composer;
                if (songData.original_key)
                    document.getElementById('song-key').textContent = songData.original_key;
                if (songData.genre)
                    document.getElementById('song-genre').textContent = songData.genre;
                if (songData.time_signature)
                    document.getElementById('song-time').textContent = songData.time_signature;
            } catch (err) {
                document.getElementById('song-title').textContent = 'Error loading song';
            }
        }

        async function loadSongChords() {
            try {
                // Load sections with measures and chords
                const res = await fetch(`${API_BASE}/api/v1/songs/${songId}/sections`);
                if (!res.ok) throw new Error('Failed to load sections');
                const sections = await res.json();

                allChords = [];
                let chordIndex = 0;

                const display = document.getElementById('sections-display');
                display.innerHTML = '';

                for (const section of sections) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'section-block';

                    const sectionHeader = document.createElement('div');
                    sectionHeader.className = 'section-header';
                    sectionHeader.textContent = section.name || `Section ${section.section_order}`;
                    sectionDiv.appendChild(sectionHeader);

                    // Load measures for this section
                    const measRes = await fetch(`${API_BASE}/api/v1/measures/section/${section.id}`);
                    const measures = measRes.ok ? await measRes.json() : [];

                    const measuresRow = document.createElement('div');
                    measuresRow.className = 'measures-row';

                    for (const measure of measures) {
                        const measureDiv = document.createElement('div');
                        measureDiv.className = 'measure-block';

                        const measureNum = document.createElement('div');
                        measureNum.className = 'measure-number';
                        measureNum.textContent = measure.measure_number;
                        measureDiv.appendChild(measureNum);

                        const chordsDiv = document.createElement('div');
                        chordsDiv.className = 'measure-chords';

                        const measureChords = measure.chords || [];
                        for (const chord of measureChords) {
                            const card = document.createElement('div');
                            card.className = 'chord-card';
                            card.dataset.index = chordIndex;
                            card.dataset.symbol = chord.chord_symbol;

                            const symbolSpan = document.createElement('div');
                            symbolSpan.className = 'chord-symbol';
                            symbolSpan.textContent = normalizeChordDisplay(chord.chord_symbol);
                            card.appendChild(symbolSpan);

                            const romanSpan = document.createElement('div');
                            romanSpan.className = 'roman-numeral';
                            romanSpan.style.display = 'none';
                            card.appendChild(romanSpan);

                            card.addEventListener('click', () => openChordEditor(parseInt(card.dataset.index)));

                            chordsDiv.appendChild(card);
                            allChords.push({
                                index: chordIndex,
                                id: chord.id,
                                measure_id: chord.measure_id,
                                beat_position: chord.beat_position,
                                chord_order: chord.chord_order,
                                symbol: chord.chord_symbol,
                                element: card,
                                romanElement: romanSpan
                            });
                            chordIndex++;
                        }

                        measureDiv.appendChild(chordsDiv);
                        measuresRow.appendChild(measureDiv);
                    }

                    sectionDiv.appendChild(measuresRow);
                    display.appendChild(sectionDiv);
                }

                // Expose allChords to window for audio integration
                window.allChords = allChords;

                document.getElementById('chord-display').innerHTML = '';

                if (allChords.length === 0) {
                    document.getElementById('chord-display').innerHTML =
                        '<p class="empty">No chords found for this song.</p>';
                }
            } catch (err) {
                document.getElementById('chord-display').innerHTML =
                    `<p class="error">Failed to load chords: ${err.message}</p>`;
            }
        }

        async function loadAnalysis(forceRefresh = false) {
            try {
                const url = `${API_BASE}/api/v1/analysis/songs/${songId}${forceRefresh ? '?refresh=true' : ''}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('Analysis failed');
                analysisData = await res.json();
                renderAnalysis();
            } catch (err) {
                console.error('Analysis error:', err);
                document.getElementById('detected-key').textContent = 'Analysis unavailable';
            }
        }

        // ==========================================
        // RENDERING
        // ==========================================

        function renderAnalysis() {
            if (!analysisData) return;

            // Show detected key and confidence
            document.getElementById('detected-key').textContent =
                `Key: ${analysisData.detected_key}`;
            const conf = Math.round((analysisData.confidence || 0) * 100);
            document.getElementById('confidence').textContent = `(${conf}% confidence)`;

            // Color-code each chord card
            const analyzedChords = analysisData.chords || [];
            for (const ac of analyzedChords) {
                const chordInfo = allChords[ac.index];
                if (!chordInfo) continue;

                const card = chordInfo.element;
                const romanEl = chordInfo.romanElement;

                // Set function class and color
                card.className = 'chord-card chord-function-' + ac.function;
                if (ac.is_override) card.classList.add('is-override');

                // Show roman numeral
                romanEl.textContent = ac.roman;
                romanEl.style.display = currentView === 'analysis' ? '' : 'none';

                // Secondary target
                if (ac.is_secondary && ac.secondary_target) {
                    let targetEl = card.querySelector('.secondary-target');
                    if (!targetEl) {
                        targetEl = document.createElement('div');
                        targetEl.className = 'secondary-target';
                        card.appendChild(targetEl);
                    }
                    targetEl.textContent = `of ${ac.secondary_target}`;
                    targetEl.style.display = currentView === 'analysis' ? '' : 'none';
                }

                // Pivot chord indicator
                if (ac.is_pivot) {
                    card.classList.add('is-pivot');
                }
            }

            // Render patterns
            renderPatterns(analysisData.patterns || []);
        }

        function renderPatterns(patterns) {
            const container = document.getElementById('patterns-info');
            if (patterns.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = '';
            container.innerHTML = '<strong>Patterns detected:</strong> ' +
                patterns.map(p =>
                    `<span class="pattern-tag">${escHtml(p.type)} (${p.description})</span>`
                ).join(' ');

            // Highlight pattern chords
            for (const pattern of patterns) {
                for (const idx of pattern.indices) {
                    const chordInfo = allChords[idx];
                    if (chordInfo) {
                        chordInfo.element.classList.add('pattern-highlight');
                    }
                }
            }
        }

        // ==========================================
        // VIEW SWITCHING
        // ==========================================

        function switchView(view) {
            currentView = view;
            const isAnalysis = view === 'analysis';
            const isNotes = view === 'notes';

            document.getElementById('analysis-controls').style.display = isAnalysis ? '' : 'none';
            document.getElementById('function-legend').style.display = isAnalysis ? '' : 'none';
            document.getElementById('patterns-info').style.display =
                isAnalysis && analysisData?.patterns?.length ? '' : 'none';

            // Toggle notes vs chord views
            document.getElementById('sections-display').style.display = isNotes ? 'none' : '';
            document.getElementById('chord-display').style.display = isNotes ? 'none' : '';
            document.getElementById('notes-display').style.display = isNotes ? '' : 'none';

            if (isNotes) {
                loadNotesView();
                return;
            }

            // Toggle roman numerals visibility
            for (const chord of allChords) {
                chord.romanElement.style.display = isAnalysis ? '' : 'none';
                const secTarget = chord.element.querySelector('.secondary-target');
                if (secTarget) secTarget.style.display = isAnalysis ? '' : 'none';
            }

            // Reset chord card classes if switching to chords view
            if (!isAnalysis) {
                for (const chord of allChords) {
                    chord.element.className = 'chord-card';
                }
            } else if (analysisData) {
                renderAnalysis();
            } else {
                loadAnalysis();
            }
        }

        document.querySelectorAll('input[name="view"]').forEach(radio => {
            radio.addEventListener('change', (e) => switchView(e.target.value));
        });

        // ==========================================
        // RE-ANALYZE
        // ==========================================

        document.getElementById('reanalyze-btn').addEventListener('click', async () => {
            const keyOverride = document.getElementById('key-select').value || null;

            try {
                const res = await fetch(`${API_BASE}/api/v1/analysis/songs/${songId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key_override: keyOverride })
                });

                if (!res.ok) throw new Error('Re-analysis failed');
                analysisData = await res.json();
                renderAnalysis();
            } catch (err) {
                alert('Re-analysis failed: ' + err.message);
            }
        });

        // ==========================================
        // CHORD EDITOR MODAL
        // ==========================================

        function openChordEditor(chordIndex) {
            // In chords view: open chord symbol editor
            if (currentView === 'chords') {
                openChordSymbolEditor(chordIndex);
                return;
            }

            // In analysis view: open analysis override modal
            if (!analysisData) return;

            editingChordIndex = chordIndex;
            const ac = analysisData.chords.find(c => c.index === chordIndex);
            if (!ac) return;

            // Populate chord symbol dropdowns
            const parsed = parseChordSymbol(ac.symbol);
            const modalRoot = document.getElementById('modal-root');
            modalRoot.value = parsed.root;
            if (modalRoot.value !== parsed.root) modalRoot.value = 'C';

            const modalQual = document.getElementById('modal-quality');
            modalQual.value = parsed.quality;
            if (modalQual.value !== parsed.quality) modalQual.value = '';

            document.getElementById('modal-ext').value = parsed.extension || '';
            document.getElementById('modal-bass').value = parsed.bass || '';
            updateAnalysisChordPreview();

            document.getElementById('modal-roman-auto').value = ac.roman;
            document.getElementById('modal-roman').value = ac.is_override ? ac.roman : '';
            document.getElementById('modal-function').value = '';
            document.getElementById('modal-key-context').value = ac.key_context || '';
            document.getElementById('modal-is-pivot').checked = ac.is_pivot || false;
            document.getElementById('modal-pivot-key').value = ac.pivot_to_key || '';
            document.getElementById('modal-notes').value = ac.notes || '';

            document.getElementById('pivot-key-group').style.display =
                ac.is_pivot ? '' : 'none';

            document.getElementById('chord-modal').style.display = 'flex';
        }

        function updateAnalysisChordPreview() {
            const root = document.getElementById('modal-root').value;
            const quality = document.getElementById('modal-quality').value;
            const ext = document.getElementById('modal-ext').value;
            const bass = document.getElementById('modal-bass').value;
            let symbol = root + quality + ext;
            if (bass) symbol += '/' + bass;
            document.getElementById('modal-symbol-preview').textContent = symbol;
        }

        // ==========================================
        // CHORD SYMBOL EDITOR (Chords View)
        // ==========================================

        let editingChordData = null;

        function parseChordSymbol(symbol) {
            if (!symbol) return { root: 'C', quality: '', extension: '', bass: '' };

            // Normalize MuseScore jazz font first
            symbol = normalizeChordDisplay(symbol);

            // Extract bass note (slash chord), e.g. Cmaj7/E â†’ bass=E
            let bass = '';
            let mainPart = symbol;
            const slashIdx = symbol.indexOf('/');
            if (slashIdx > 0) {
                bass = symbol.slice(slashIdx + 1);
                mainPart = symbol.slice(0, slashIdx);
            }

            // Match root note
            const rootMatch = mainPart.match(/^([A-G][#b]?)(.*)/);
            if (!rootMatch) return { root: 'C', quality: '', extension: '', bass };
            const root = rootMatch[1];
            const remainder = rootMatch[2];

            // Greedy-match known quality strings (longest first)
            const qualities = [
                'm7b5','mmaj7','aug7','maj7','dim7','maj9','sus4','sus2',
                '7#9','7b9','m7','m9','m6','13','dim','aug','alt','m','7','6','9',''
            ];
            let quality = '';
            let extension = remainder;
            for (const q of qualities) {
                if (remainder.startsWith(q)) {
                    quality = q;
                    extension = remainder.slice(q.length);
                    break;
                }
            }

            // Validate extension against known list; clear if unrecognised
            const knownExts = ['9','b9','#9','11','#11','13','b13','add9','add11'];
            if (!knownExts.includes(extension)) extension = '';

            return { root, quality, extension, bass };
        }

        function openChordSymbolEditor(chordIndex) {
            const chordInfo = allChords[chordIndex];
            if (!chordInfo) return;

            editingChordData = chordInfo;
            const parsed = parseChordSymbol(chordInfo.symbol);

            document.getElementById('edit-current-symbol').value = chordInfo.symbol;

            // Set root dropdown
            const rootSelect = document.getElementById('edit-root');
            rootSelect.value = parsed.root;
            if (rootSelect.value !== parsed.root) {
                for (const opt of rootSelect.options) {
                    if (opt.value === parsed.root) { rootSelect.value = parsed.root; break; }
                }
            }

            // Set quality dropdown
            const qualitySelect = document.getElementById('edit-quality');
            qualitySelect.value = parsed.quality;
            if (qualitySelect.value !== parsed.quality) {
                qualitySelect.value = '';
            }

            // Set extension dropdown
            const extSelect = document.getElementById('edit-extension');
            extSelect.value = parsed.extension || '';

            // Set bass note dropdown
            const bassSelect = document.getElementById('edit-bass');
            bassSelect.value = parsed.bass || '';

            updateChordPreview();
            document.getElementById('chord-edit-modal').style.display = 'flex';
        }

        function closeChordEditModal() {
            document.getElementById('chord-edit-modal').style.display = 'none';
            editingChordData = null;
        }

        function updateChordPreview() {
            const root = document.getElementById('edit-root').value;
            const quality = document.getElementById('edit-quality').value;
            const extension = document.getElementById('edit-extension').value;
            const bass = document.getElementById('edit-bass').value;
            let symbol = root + quality + extension;
            if (bass) symbol += '/' + bass;
            document.getElementById('edit-preview').textContent = symbol;
        }

        async function saveChordEdit() {
            if (!editingChordData) return;

            const root = document.getElementById('edit-root').value;
            const quality = document.getElementById('edit-quality').value;
            const extension = document.getElementById('edit-extension').value;
            const bass = document.getElementById('edit-bass').value;
            let newSymbol = root + quality + extension;
            if (bass) newSymbol += '/' + bass;

            const payload = {
                measure_id: editingChordData.measure_id,
                beat_position: editingChordData.beat_position,
                chord_symbol: newSymbol,
                chord_order: editingChordData.chord_order
            };

            try {
                const res = await fetch(
                    `${API_BASE}/api/v1/chords/${editingChordData.id}`,
                    {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!res.ok) throw new Error('Save failed');

                // Update the UI immediately
                editingChordData.symbol = newSymbol;
                editingChordData.element.querySelector('.chord-symbol').textContent = newSymbol;
                editingChordData.element.dataset.symbol = newSymbol;

                closeChordEditModal();
            } catch (err) {
                alert('Failed to save chord: ' + err.message);
            }
        }

        // Close chord edit modal on backdrop click
        document.getElementById('chord-edit-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeChordEditModal();
        });

        document.getElementById('modal-is-pivot').addEventListener('change', (e) => {
            document.getElementById('pivot-key-group').style.display =
                e.target.checked ? '' : 'none';
        });

        function closeChordModal() {
            document.getElementById('chord-modal').style.display = 'none';
            editingChordIndex = null;
        }

        async function saveOverride() {
            if (editingChordIndex === null) return;

            // Compose new chord symbol from dropdowns
            const root = document.getElementById('modal-root').value;
            const quality = document.getElementById('modal-quality').value;
            const ext = document.getElementById('modal-ext').value;
            const bass = document.getElementById('modal-bass').value;
            let newSymbol = root + quality + ext;
            if (bass) newSymbol += '/' + bass;

            const payload = {
                roman: document.getElementById('modal-roman').value || null,
                function: document.getElementById('modal-function').value || null,
                key_context: document.getElementById('modal-key-context').value || null,
                is_pivot: document.getElementById('modal-is-pivot').checked,
                pivot_to_key: document.getElementById('modal-pivot-key').value || null,
                notes: document.getElementById('modal-notes').value || null
            };

            try {
                // Update chord symbol in DB if changed
                const chordInfo = allChords[editingChordIndex];
                if (chordInfo && newSymbol !== chordInfo.symbol) {
                    const chordPayload = {
                        measure_id: chordInfo.measure_id,
                        beat_position: chordInfo.beat_position,
                        chord_symbol: newSymbol,
                        chord_order: chordInfo.chord_order
                    };
                    const chordRes = await fetch(
                        `${API_BASE}/api/v1/chords/${chordInfo.id}`,
                        {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(chordPayload)
                        }
                    );
                    if (!chordRes.ok) throw new Error('Failed to update chord symbol');
                    chordInfo.symbol = newSymbol;
                    chordInfo.element.querySelector('.chord-symbol').textContent = newSymbol;
                    chordInfo.element.dataset.symbol = newSymbol;
                }

                // Save analysis override
                const res = await fetch(
                    `${API_BASE}/api/v1/analysis/songs/${songId}/chord/${editingChordIndex}`,
                    {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!res.ok) throw new Error('Save failed');

                closeChordModal();
                await loadAnalysis(true);
            } catch (err) {
                alert('Failed to save: ' + err.message);
            }
        }

        async function deleteOverride() {
            if (editingChordIndex === null) return;

            try {
                const res = await fetch(
                    `${API_BASE}/api/v1/analysis/songs/${songId}/chord/${editingChordIndex}`,
                    { method: 'DELETE' }
                );

                if (!res.ok) throw new Error('Delete failed');

                closeChordModal();
                await loadAnalysis(true);
            } catch (err) {
                alert('Failed to reset override: ' + err.message);
            }
        }

        // ==========================================
        // CHORD NOTATION NORMALIZATION (FAIL 2)
        // ==========================================

        function normalizeChordDisplay(symbol) {
            if (!symbol) return '';
            // Extract root note first
            const rootMatch = symbol.match(/^([A-G][#b]?)(.*)/);
            if (!rootMatch) return symbol;
            const root = rootMatch[1];
            let quality = rootMatch[2];

            // Normalize MuseScore jazz font notation
            quality = quality.replace(/^\^/, 'maj');      // ^7 -> maj7, ^9 -> maj9
            quality = quality.replace(/^-/, 'm');          // -7 -> m7, -9 -> m9
            quality = quality.replace(/^0(\d)/, 'dim$1');  // 07 -> dim7
            quality = quality.replace(/^o(\d)/, 'dim$1');  // o7 -> dim7
            if (quality === 't' || quality === '\u0394') quality = 'maj7';
            if (quality === 'Maj') quality = '';

            return root + quality;
        }

        // ==========================================
        // EXPORT BUTTON (FAIL 3)
        // ==========================================

        document.getElementById('export-btn').addEventListener('click', async () => {
            const btn = document.getElementById('export-btn');
            btn.disabled = true;
            btn.textContent = 'Exporting...';
            try {
                const res = await fetch(
                    `${API_BASE}/api/v1/exports/musescore/${songId}?format=mscz&include_analysis=true`
                );
                if (!res.ok) throw new Error('Export failed');
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${(songData?.title || 'song').replace(/[^a-zA-Z0-9 ]/g, '')}_analyzed.mscz`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                alert('Export failed: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Export .mscz';
            }
        });

        // ==========================================
        // RHYTHM ANALYSIS (FAIL 4)
        // ==========================================

        async function loadRhythmAnalysis() {
            try {
                const res = await fetch(`${API_BASE}/api/v1/midi/rhythm/song/${songId}`);
                if (!res.ok) return;
                const data = await res.json();

                const panel = document.getElementById('rhythm-panel');
                panel.style.display = '';

                // Feel badge
                const feelEl = document.getElementById('rhythm-feel');
                feelEl.textContent = (data.feel || 'unknown').toUpperCase();
                feelEl.className = 'rhythm-badge rhythm-' + (data.feel || 'unknown');

                // Stats
                document.getElementById('rhythm-ratio').textContent =
                    data.swing_ratio != null ? data.swing_ratio + ':1' : '--';
                document.getElementById('rhythm-sync').textContent =
                    data.syncopation_score != null ? Math.round(data.syncopation_score * 100) + '%' : '--';
                document.getElementById('rhythm-subdiv').textContent =
                    data.primary_subdivision || '--';

                // Source label
                const sourceEl = document.getElementById('rhythm-source');
                if (data.source === 'chord_positions') {
                    sourceEl.textContent = 'Based on chord positions. Import MIDI with note data for detailed analysis.';
                } else if (data.source === 'melody_notes') {
                    sourceEl.textContent = 'Based on MIDI note data.';
                }
            } catch (err) {
                console.log('Rhythm analysis unavailable:', err.message);
            }
        }

        // ==========================================
        // WEB MIDI DETECTION (FAIL 5)
        // ==========================================

        let midiAccess = null;
        let activeNotes = new Set();
        let midiIdentifyTimeout = null;

        async function initMIDI() {
            const statusEl = document.getElementById('midi-status');
            if (!navigator.requestMIDIAccess) {
                statusEl.textContent = 'MIDI: Not supported (use Chrome/Edge)';
                statusEl.className = 'midi-status midi-unsupported';
                return;
            }
            try {
                midiAccess = await navigator.requestMIDIAccess();
                updateMIDIDevices();
                midiAccess.onstatechange = updateMIDIDevices;
            } catch (err) {
                statusEl.textContent = 'MIDI: Access denied';
                statusEl.className = 'midi-status midi-disconnected';
            }
        }

        function updateMIDIDevices() {
            const statusEl = document.getElementById('midi-status');
            const inputs = Array.from(midiAccess.inputs.values());
            if (inputs.length === 0) {
                statusEl.textContent = 'MIDI: No device connected';
                statusEl.className = 'midi-status midi-disconnected';
                return;
            }
            const deviceName = inputs[0].name || 'Unknown Device';
            statusEl.textContent = `MIDI: ${deviceName}`;
            statusEl.className = 'midi-status midi-connected';

            // Listen to all inputs
            for (const input of inputs) {
                input.onmidimessage = handleMIDIMessage;
            }
        }

        function handleMIDIMessage(msg) {
            const [status, note, velocity] = msg.data;
            const command = status & 0xf0;

            if (command === 0x90 && velocity > 0) {
                // Note ON
                activeNotes.add(note);
                scheduleMIDIIdentify();
            } else if (command === 0x80 || (command === 0x90 && velocity === 0)) {
                // Note OFF
                activeNotes.delete(note);
            }
        }

        function scheduleMIDIIdentify() {
            clearTimeout(midiIdentifyTimeout);
            midiIdentifyTimeout = setTimeout(async () => {
                if (activeNotes.size < 2) return; // Need at least 2 notes for a chord
                const notes = Array.from(activeNotes).sort((a, b) => a - b);
                try {
                    const keyContext = analysisData?.detected_key || null;
                    const res = await fetch(`${API_BASE}/api/v1/midi/identify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notes, key_context: keyContext })
                    });
                    if (!res.ok) return;
                    const data = await res.json();

                    const displayEl = document.getElementById('midi-chord-display');
                    displayEl.style.display = '';
                    document.getElementById('midi-chord-symbol').textContent =
                        normalizeChordDisplay(data.chord_symbol) || '?';
                    document.getElementById('midi-chord-roman').textContent =
                        data.roman_numeral ? `(${data.roman_numeral})` : '';
                    document.getElementById('midi-chord-roman').style.color =
                        data.function_color || 'inherit';
                } catch (err) {
                    console.log('MIDI identify error:', err.message);
                }
            }, 100); // 100ms debounce
        }

        // ==========================================
        // NOTES VIEW (FAIL 1)
        // ==========================================

        let notesData = null;

        async function loadNotesView() {
            const content = document.getElementById('notes-content');
            if (notesData) {
                renderNotesTable(notesData);
                return;
            }
            content.innerHTML = '<p class="loading">Loading notes...</p>';
            try {
                const res = await fetch(`${API_BASE}/api/v1/songs/${songId}/notes`);
                if (!res.ok) {
                    if (res.status === 404) {
                        content.innerHTML = `
                            <div class="notes-empty">
                                <p>No note data available for this song.</p>
                                <p>Upload the original .mscz file to extract individual notes for analysis audit.</p>
                                <div class="notes-upload-area">
                                    <input type="file" id="notes-file-input" accept=".mscz,.mscx" style="display:none">
                                    <button class="btn btn-primary" onclick="document.getElementById('notes-file-input').click()">
                                        Upload .mscz for Note Extraction
                                    </button>
                                </div>
                            </div>`;
                        document.getElementById('notes-file-input').addEventListener('change', handleNotesUpload);
                        return;
                    }
                    throw new Error('Failed to load notes');
                }
                notesData = await res.json();
                renderNotesTable(notesData);
            } catch (err) {
                content.innerHTML = `<p class="error">Failed to load notes: ${err.message}</p>`;
            }
        }

        function midiToNoteName(midi) {
            const names = ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'];
            const octave = Math.floor(midi / 12) - 1;
            return names[midi % 12] + octave;
        }

        function renderNotesTable(data) {
            const notes = data.notes || [];
            const content = document.getElementById('notes-content');

            if (notes.length === 0) {
                content.innerHTML = `
                    <div class="notes-empty">
                        <p>No note data found. Upload the .mscz file to extract notes.</p>
                        <div class="notes-upload-area">
                            <input type="file" id="notes-file-input" accept=".mscz,.mscx" style="display:none">
                            <button class="btn btn-primary" onclick="document.getElementById('notes-file-input').click()">
                                Upload .mscz for Note Extraction
                            </button>
                        </div>
                    </div>`;
                document.getElementById('notes-file-input').addEventListener('change', handleNotesUpload);
                return;
            }

            // Build chord lookup by measure
            const chordsByMeasure = {};
            if (analysisData?.chords) {
                for (const ch of analysisData.chords) {
                    if (!chordsByMeasure[ch.measure]) chordsByMeasure[ch.measure] = [];
                    chordsByMeasure[ch.measure].push(normalizeChordDisplay(ch.symbol));
                }
            }

            let html = '<table class="notes-table"><thead><tr>';
            html += '<th>Measure</th><th>Beat</th><th>Note</th><th>MIDI</th><th>Duration</th><th>Chord</th>';
            html += '</tr></thead><tbody>';

            for (const n of notes) {
                const chords = chordsByMeasure[n.measure_number] || [];
                const chordStr = chords.join(', ') || '--';
                html += `<tr>
                    <td>${n.measure_number}</td>
                    <td>${n.beat_position.toFixed(1)}</td>
                    <td class="note-name">${midiToNoteName(n.midi_note)}</td>
                    <td>${n.midi_note}</td>
                    <td>${n.duration || '--'}</td>
                    <td>${escHtml(chordStr)}</td>
                </tr>`;
            }

            html += '</tbody></table>';
            html += `<p class="notes-count">${notes.length} notes across ${new Set(notes.map(n => n.measure_number)).size} measures</p>`;
            content.innerHTML = html;
        }

        async function handleNotesUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const content = document.getElementById('notes-content');
            content.innerHTML = '<p class="loading">Extracting notes...</p>';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('song_id', songId);

            try {
                const res = await fetch(`${API_BASE}/api/v1/imports/score/reparse-notes`, {
                    method: 'POST',
                    body: formData
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Note extraction failed');
                }
                const data = await res.json();
                content.innerHTML = `<p class="success">Extracted ${data.notes_count} notes. Loading...</p>`;
                notesData = null; // Clear cache
                await loadNotesView();
            } catch (err) {
                content.innerHTML = `<p class="error">Note extraction failed: ${err.message}</p>`;
            }
        }

        // ==========================================
        // UTILITIES
        // ==========================================

        function escHtml(str) {
            if (!str) return '';
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        // Close modal on backdrop click
        document.getElementById('chord-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeChordModal();
        });
    </script>
    <script src="js/auth.js"></script>
    <script src="js/audio.js"></script>
    <script>
        // Auth gate - check before showing page
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await window.auth.checkAuth();
            if (!isAuthenticated) {
                window.location.href = '/login.html';
                return;
            }
            // Authenticated - show page and load content
            document.body.style.display = '';
            window.auth.updateAuthUI();
            init();
            setupChordAudio();
        });

        // ==========================================
        // CHORD AUDIO PLAYBACK
        // ==========================================

        let audioInitialized = false;

        function setupChordAudio() {
            // Add audio control panel
            const controlsBar = document.querySelector('.controls-bar');
            const audioPanel = document.createElement('div');
            audioPanel.className = 'audio-panel';
            audioPanel.innerHTML = `
                <button id="audio-unlock-btn" class="audio-btn" title="Click to enable audio">
                    ðŸ”Š Enable Audio
                </button>
                <div class="volume-control" style="display: none;">
                    <span class="volume-icon">ðŸ”Š</span>
                    <input type="range" id="volume-slider" min="0" max="100" value="80" title="Volume">
                </div>
                <span id="audio-hint" class="audio-hint" style="display: none;">Click any chord to hear it</span>
            `;
            controlsBar.appendChild(audioPanel);

            // Unlock button handler
            document.getElementById('audio-unlock-btn').addEventListener('click', async () => {
                await initAudioIfNeeded();
                if (audioInitialized) {
                    document.getElementById('audio-unlock-btn').style.display = 'none';
                    document.querySelector('.audio-panel .volume-control').style.display = 'flex';
                    document.getElementById('audio-hint').style.display = '';
                }
            });

            // Volume slider
            document.getElementById('volume-slider').addEventListener('input', (e) => {
                const vol = parseInt(e.target.value) / 100;
                HarmonyAudio.setVolume(vol);
            });
        }

        async function initAudioIfNeeded() {
            if (audioInitialized) return;
            try {
                await HarmonyAudio.init();
                audioInitialized = true;
            } catch (err) {
                console.error('Failed to initialize audio:', err);
            }
        }

        async function playChord(symbol) {
            if (!audioInitialized) {
                await initAudioIfNeeded();
            }
            if (audioInitialized && symbol && symbol !== '?') {
                HarmonyAudio.play(symbol, 1.5);
            }
        }

        // Override chord card click to include audio
        // Must use window. to modify global function, not create local shadow
        const originalOpenChordEditor = window.openChordEditor;
        window.openChordEditor = function(chordIndex) {
            // Play the chord on click (with defensive check)
            if (window.allChords && window.allChords.length > 0) {
                const chordInfo = window.allChords[chordIndex];
                if (chordInfo && chordInfo.symbol) {
                    playChord(chordInfo.symbol);
                }
            }
            // Then open editor if in analysis mode
            originalOpenChordEditor(chordIndex);
        };
    </script>
    <style>
        /* Audio Panel Styles */
        .audio-panel {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .audio-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.15s;
        }

        .audio-btn:hover {
            border-color: var(--accent);
            background: var(--bg-hover);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .volume-icon {
            font-size: 1rem;
        }

        #volume-slider {
            width: 70px;
            height: 5px;
            border-radius: 3px;
            background: var(--bg);
            cursor: pointer;
            -webkit-appearance: none;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        .audio-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Chord card hover effect when audio enabled */
        .chord-card {
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .chord-card:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Rhythm Panel (FAIL 4) */
        .rhythm-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            margin-bottom: 12px;
        }

        .rhythm-header {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .rhythm-details {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 16px;
        }

        .rhythm-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .rhythm-swing { background: #f59e0b; color: #000; }
        .rhythm-straight { background: #3b82f6; color: #fff; }
        .rhythm-reverse_swing { background: #8b5cf6; color: #fff; }
        .rhythm-unknown { background: var(--bg-hover); color: var(--text); }
        .rhythm-insufficient_data { background: var(--bg-hover); color: var(--text-muted); }

        .rhythm-stat {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .rhythm-stat strong {
            color: var(--text);
        }

        .rhythm-source {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* MIDI Panel (FAIL 5) */
        .midi-panel {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 6px 16px;
            margin-bottom: 8px;
        }

        .midi-status {
            font-size: 0.8rem;
            padding: 3px 10px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .midi-connected {
            background: rgba(34, 197, 94, 0.15);
            border-color: #22c55e;
            color: #22c55e;
        }

        .midi-disconnected {
            background: var(--bg-card);
            color: var(--text-muted);
        }

        .midi-unsupported {
            background: var(--bg-card);
            color: var(--text-muted);
            font-style: italic;
        }

        .midi-chord-display {
            display: flex;
            align-items: baseline;
            gap: 8px;
            background: var(--bg-card);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 4px 12px;
        }

        .midi-chord-symbol {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--text);
        }

        .midi-chord-roman {
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Notes Table (FAIL 1) */
        .notes-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .notes-table th {
            background: var(--bg-card);
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 8px 12px;
            text-align: left;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
        }

        .notes-table td {
            padding: 6px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .notes-table tr:hover {
            background: var(--bg-hover);
        }

        .note-name {
            font-weight: bold;
            font-family: monospace;
            font-size: 0.95rem;
        }

        .notes-count {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: right;
        }

        .notes-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .notes-upload-area {
            margin-top: 16px;
        }

        .success {
            color: #22c55e;
        }
    </style>
</body>
</html>
