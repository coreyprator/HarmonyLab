# CC Task: HL-MS2 â€” HarmonyLab Fixes + MIDI Features

> **Sprint ID**: HL-MS2
> **Wave**: 1 (continued)
> **Estimated CC Time**: 10â€“14 hours
> **Project**: HarmonyLab ðŸ”µ
> **Generated by**: CAI 2026-02-28
> **Bootstrap**: v1.4.3
> **Source**: PL UAT of HL-MS1-FIX (14P/3F/2S) + new requirements from UAT observations

---

## PHASE 0: VERIFICATION GATE

Before any work:

1. Read the Bootstrap prompt: `cat project-methodology/CC_Bootstrap_Prompt.md`
2. Read PROJECT_KNOWLEDGE.md: `cat harmonylab/PROJECT_KNOWLEDGE.md`
3. Read INTENT.md: `cat harmonylab/INTENT.md`
4. Verify service account:
   ```bash
   gcloud auth list
   # Must show: cc-deploy@super-flashcards-475210.iam.gserviceaccount.com
   ```
5. Verify current deployment:
   ```bash
   curl https://harmonylab.rentyourcio.com/health
   # Must show version 2.0.1
   ```
6. Report all checkpoint codes found:
   ```
   PHASE 0 VERIFICATION
   â”œâ”€â”€ Bootstrap: [code]
   â”œâ”€â”€ PK.md: [code]
   â””â”€â”€ INTENT.md: [code]
   All documents read. Proceeding to Phase 1.
   ```

**STOP if any checkpoint is missing or service account is wrong.**

---

## GOAL

Fix 3 remaining UAT failures from v2.0.1, then add MIDI-based features that PL identified as high-value during testing. The MIDI real-time chord identification was a breakthrough ("Wow! That's amazing!" â€” PL during UAT). This sprint builds on that momentum.

**Part A â€” Fix 3 failures (unblocks PL auditing):**
1. Song 65 "No chords found" â€” bug persists despite CC claiming it was fixed
2. Note extraction `[object Object]` error â€” API returns object, frontend expects string
3. Import Notes same error â€” same root cause

**Part B â€” 6 new features (extends MIDI capabilities):**
1. MIDI Quiz Mode â€” reverse flow: app plays chord, PL identifies on keyboard
2. Show MIDI notes played â€” real-time display for auditing analysis
3. MIDI chord ID for altered extensions â€” fix b9/b13/#11 vocabulary gap
4. Roman numeral "?" fix for multi-chord measures
5. Delete song CRUD
6. Timestamps on PK.md and SESSION_CLOSEOUT.md

---

## PART A: FIX 3 UAT FAILURES

### FIX 1: Song 65 "No chords found" (CRITICAL)

**Problem:** Song 65 (Almost Like Being in Love) shows "No chords found" despite database having 31 chords at 95.6% confidence. Previous CC said "ID confusion, no fix needed" but the bug persists.

**Investigation steps:**
1. Query the database: `SELECT * FROM SongChords WHERE song_id = 65`
2. If chords exist in DB, the bug is in the frontend query â€” the song detail page is fetching with wrong ID or wrong endpoint
3. Check: is the frontend using a different ID field (e.g., UUID vs integer)?
4. Check: are the API routes filtering by a field that doesn't match?

**Acceptance:** Open song 65 in browser. 31 chords display. Confidence shows 95.6%.

### FIX 2 & 3: Note Extraction `[object Object]` Error

**Problem:** On the Notes tab, clicking "Import Notes" or viewing notes shows `Note extraction failed: [object Object]`. The API returns a JSON object but the frontend error handler does `catch(e) { show(e) }` which renders the object as `[object Object]` instead of the error message.

**Fix approach:**
1. Find the fetch call for note extraction in the frontend JS
2. Fix error handling: extract `.message` or `.detail` from the error response
3. Test the actual API endpoint directly: `curl -X POST /imports/score/reparse-notes -F "file=@song.mscz"`
4. If the API itself fails, fix the backend too â€” check the voice element detection bug (documented in v2.0.1 SESSION_CLOSEOUT: `.findall('.//voice')` found text elements instead of containers)
5. Test with a .mscz file that has pitched staff notation (not a lead sheet)

**Acceptance:**
- Upload a .mscz file with staff notation on the Notes tab â†’ notes populate in table
- Upload a lead sheet â†’ shows "No note data available" (not an error)
- Error messages show human-readable text, never `[object Object]`

**Deploy after Part A. Verify all 3 fixes before starting Part B.**

---

## PART B: NEW FEATURES

### FEATURE 1: MIDI Quiz Mode (P2) â€” HL-NEW-001

**What:** Reverse of the current real-time chord ID. The app shows a chord name (e.g., "Dm7") and PL plays it on the MIDI keyboard. The app scores whether the notes played match.

**UI location:** New tab or mode toggle on any song page: "Listen" (current) | "Quiz"

**Quiz flow:**
1. App displays a target chord: name + optional Roman numeral (e.g., "Dm7 â€” ii7 in C")
2. PL plays notes on MIDI keyboard
3. App captures the notes via Web MIDI API (same pipeline as real-time ID)
4. App compares played notes against target chord's expected notes
5. Shows result: Correct / Incorrect + what was played vs expected
6. Tracks score: 7/10 correct

**Chord source options:**
- Random from current song's chord progression
- Sequential through the song's chords (practice mode)
- Random from a scale/key (drill mode)

**Scoring logic:**
- Match root + quality = correct (inversions OK)
- Show which notes were expected vs played
- Don't penalize for octave differences

**Acceptance:** Open a song with chords, switch to Quiz mode, play the displayed chord on MIDI keyboard, see correct/incorrect feedback with score tracking.

### FEATURE 2: Show MIDI Notes Played (P2) â€” HL-NEW-002

**What:** Real-time display of which MIDI notes are being pressed, alongside the chord identification.

**Problem this solves:** During UAT, PL played G + F-Ab-B (G7b9 voicing) but the app showed just "G". PL couldn't see what notes the app was receiving to debug why.

**UI:** Below or beside the chord ID display, show:
```
Notes: G3, F3, Ab3, B3
Chord: G7b9
```

If the chord ID is wrong, PL can see the raw notes and report the discrepancy.

**Implementation:**
- The Web MIDI `onmidimessage` handler already captures note-on events
- Display them in a small panel: note name + octave for each currently-held note
- Clear on all-notes-off or after a timeout (e.g., 2 seconds of no new notes)

**Acceptance:** Play any notes on MIDI keyboard. See individual note names displayed in real-time alongside the chord identification.

### FEATURE 3: MIDI Chord ID for Altered Extensions (P2) â€” HL-NEW-003

**What:** Fix the chord identification template library to recognize altered extensions: b9, #9, b13, #11, alt.

**Problem:** PL tested incrementally:
- G + B = Gmaj âœ“
- G + B + F = G7 âœ“
- G + B + F + D = G7 âœ“
- G + B + F + Ab = collapsed to just "G" âœ—

The Ab is the b9. The algorithm doesn't have a template for dominant 7 b9 chords. When it can't match, it falls back to the root only.

**Fix approach:**
1. Find the chord template/matching logic in the `/midi/identify` endpoint or frontend
2. Add templates for common altered chords:
   - 7b9 (1-3-b7-b9)
   - 7#9 (1-3-b7-#9)
   - 7b13 (1-3-b7-b13)
   - 7#11 (1-3-b7-#11)
   - 7alt (1-3-b7-b9-#9-b13) â€” match if multiple alterations present
   - 9 (1-3-5-b7-9) â€” natural 9
   - 13 (1-3-b7-13)
   - maj9 (1-3-5-7-9)
   - m9 (1-b3-5-b7-9)
   - 6/9 (1-3-5-6-9)
3. Handle partial voicings â€” jazz players often omit the 5th. Don't require all intervals.
4. Handle inversions â€” the root may not be the lowest note.

**Acceptance:**
- Play G-B-F-Ab â†’ identifies as G7b9 (not just "G")
- Play C-E-Bb-Eb â†’ identifies as C7#9
- Play Dm7 voicing (D-F-A-C) â†’ still works (regression check)

### FEATURE 4: Roman Numeral "?" Fix (P3) â€” HL-NEW-004

**What:** When a measure has 2 chords, the Roman numeral analysis shows "?" instead of analyzing each chord.

**Problem:** PL found this during NOT-03 UAT testing. The edit modal showed Roman Numeral: `?` for a Cmaj9 chord. PL noted: "I don't have notes analysis to audit. It appears to be that there are 2 chords played in the measures so that confuses analysis."

**Fix:** The analysis engine should handle multiple chords per measure:
- Assign Roman numerals to each chord independently based on the song's key
- If the key is ambiguous, use the most recent key signature or key override
- "?" should only appear if the chord root is genuinely unrecognizable, not because there are multiple chords

**Acceptance:** Open a song with 2+ chords in one measure. Both chords show Roman numerals (not "?").

### FEATURE 5: Delete Song CRUD (P3) â€” HL-NEW-005

**What:** Currently there's no way to delete a song from the library.

**Implementation:**
- Add `DELETE /api/songs/{id}` endpoint
- Cascade: delete associated chords, notes, analysis records
- Add delete button on song detail page (with confirmation dialog)
- Add delete icon on song list (optional â€” may be too dangerous for list view)

**Acceptance:** Delete a test song. Confirm it's gone from the library. Associated chords/notes also deleted.

### FEATURE 6: Timestamps on Documentation (Process)

**What:** PK.md and SESSION_CLOSEOUT.md should include ISO timestamps for race condition diagnosis.

**Implementation:**
- PK.md `Updated` line should include time: `Updated: 2026-02-28T14:30:00Z`
- SESSION_CLOSEOUT.md `Session Date` should include time: `Session Date: 2026-02-28T14:30:00Z`
- Use UTC timestamps throughout

This is a documentation standard, not a code change. Apply it to this sprint's own PK.md and SESSION_CLOSEOUT.md as the first example.

---

## IMPLEMENTATION ORDER

**Present your plan before coding. Wait for PL approval if PL is present.**

```
Phase 1: Fix Song 65 (investigate + fix)           â†’ deploy, verify
Phase 2: Fix note extraction errors (FE + BE)      â†’ deploy, verify
Phase 3: Show MIDI notes played (Feature 2)        â†’ deploy, verify
Phase 4: Altered chord templates (Feature 3)        â†’ deploy, verify
Phase 5: MIDI Quiz Mode (Feature 1)                â†’ deploy, verify
Phase 6: Roman numeral fix (Feature 4)             â†’ deploy, verify
Phase 7: Delete song (Feature 5)                   â†’ deploy, verify
Phase 8: Version bump, PK.md, closeout, UAT submit
```

**Rationale:** Fixes first (unblock PL auditing), then MIDI notes display (helps debug Feature 3), then altered chords (uses the notes display for testing), then Quiz (builds on working chord ID), then smaller items.

---

## DELIVERABLES

| # | Deliverable | Acceptance Criteria |
|---|-------------|-------------------|
| 1 | Song 65 displays chords | 31 chords visible, 95.6% confidence shown |
| 2 | Note extraction works | Upload .mscz â†’ notes populate. Lead sheet â†’ "No note data." Errors show readable messages. |
| 3 | MIDI Quiz Mode | Show chord â†’ PL plays â†’ correct/incorrect + score tracking |
| 4 | MIDI notes display | Real-time note names shown alongside chord ID |
| 5 | Altered chord templates | G7b9, C7#9, and other altered dominants identified correctly |
| 6 | Roman numeral fix | Multi-chord measures show numerals, not "?" |
| 7 | Delete song | DELETE endpoint + UI button with confirmation |
| 8 | Timestamps on docs | PK.md and SESSION_CLOSEOUT use ISO timestamps with time |
| 9 | Version bump | 2.0.1 â†’ 2.1.0 (minor: new features) |
| 10 | PK.md updated | Documents MIDI quiz, notes display, altered chord templates, delete endpoint |
| 11 | SESSION_CLOSEOUT.md | Per Bootstrap v1.4.3 with ISO timestamp |
| 12 | UAT submitted to MetaPM | Handoff + UAT IDs in mandatory closeout format |

---

## CONSTRAINTS

- **Deploy to Cloud Run after each phase** â€” do not batch all changes into one deploy
- **Test against production URL** â€” no local validation or virtual environments
- **GCP project**: super-flashcards-475210
- **Service account**: cc-deploy@super-flashcards-475210.iam.gserviceaccount.com
- **Production URL**: https://harmonylab.rentyourcio.com
- **Default branch**: main
- **Cloud SQL**: 35.224.242.223, instance flashcards-db, DB LanguageLearning
- **MIDI testing**: CC cannot test MIDI features without hardware. Document test instructions for PL. Include which chords to play and expected results.
- **Read INTENT.md and PROJECT_KNOWLEDGE.md first** â€” report checkpoint codes (Bootstrap v1.4.3 gate)
- **Use mandatory closeout format** â€” Handoff ID, UAT ID, handoff link, artifact commit hashes
- **Present implementation plan before coding** â€” wait for PL approval before executing

---

## PRIORITY ORDER (if time-limited)

1. **Song 65 fix** (1 hr â€” unblocks PL trust in chord analysis)
2. **Note extraction fix** (1 hr â€” unblocks PL auditing)
3. **MIDI notes display** (1.5 hrs â€” helps PL test everything below)
4. **Altered chord templates** (2 hrs â€” core analysis improvement)
5. **MIDI Quiz Mode** (3 hrs â€” biggest new feature)
6. **Roman numeral fix** (1.5 hrs)
7. **Delete song** (1 hr)
8. **Timestamps + version bump + closeout** (1.5 hrs)

Items 1-4 are the minimum viable sprint. Items 5-7 are stretch but high value.
